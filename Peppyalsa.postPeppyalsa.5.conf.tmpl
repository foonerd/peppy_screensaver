#------ PeppyMeter section -------

# ---> pass throught audio pipeline
# if separat alsa pipeline enabled (DSD direct)
pcm.${alsaDirect} {
  type empty
  slave.pcm "postpeppyalsa"
}

# ---> input from modular alsa 
# duplicate route for meters to play also DSD files
# Fusion bridge on: slave b = peppyalsa_meter_48k (resamples to 48k for dummy so multi runs at main rate)
pcm.${alsaMeter} {
  type plug
  route_policy "duplicate"
  slave.channels 4
  slave.pcm {
    type multi

    slaves.a.pcm "postpeppyalsa"
    slaves.a.channels 2
    slaves.b.pcm "${peppyalsaMeterSlave}"
    slaves.b.channels 2

    bindings.0 { slave a; channel 0; }
    bindings.1 { slave a; channel 1; }
    bindings.2 { slave b; channel 0; }
    bindings.3 { slave b; channel 1; }
  }
}

# ---> peppyalsa meter path: resample to 48k for dummy (Fusion bridge)
# speexrate handles high conversion ratios (e.g. 384k->48k) unlike the default converter
pcm.peppyalsa_meter_48k {
  type plug
  slave {
    rate 48000
    pcm "mpd_peppyalsa"
  }
  rate_converter "speexrate"
}

# ---> input from exclusive MPD output for peppyalsa
# without audio output (dummy)
pcm.mpd_peppyalsa{
	type meter
	slave.pcm "dummy"
	scopes.0 peppyalsa
}

# ---> separate airplay input
pcm.airplay {
	type meter
	slave.pcm "postpeppyalsa"
	scopes.0 peppyalsa
}

# ---> separate spotify input
pcm.${spotDirect} {
  type empty
  slave.pcm "postpeppyalsa"
}

# spotify with meter using multi/duplicate pattern
# main audio bypasses meter, meter receives duplicate to dummy
# this avoids hw_params issues when meter is inline with main audio
pcm.${spotMeter} {
  type plug
  route_policy "duplicate"
  slave.channels 4
  slave.pcm {
    type multi

    slaves.a.pcm "postpeppyalsa"
    slaves.a.channels 2
    slaves.b.pcm "spd_peppyalsa"
    slaves.b.channels 2

    bindings.0 { slave a; channel 0; }
    bindings.1 { slave a; channel 1; }
    bindings.2 { slave b; channel 0; }
    bindings.3 { slave b; channel 1; }
  }
}

# spotify meter to dummy - side path for meter data only
pcm.spd_peppyalsa {
  type meter
  slave.pcm "dummy"
  scopes.0 peppyalsa
}

# standard scope
pcm_scope.peppyalsa {
  type peppyalsa
  decay_ms 500
  meter "/tmp/myfifo"
  meter_max 100
  meter_show 0
  spectrum "/tmp/myfifosa"
  spectrum_max 100
  spectrum_size 20
  logarithmic_frequency 1
  logarithmic_amplitude 1
  smoothing_factor 60
}

pcm_scope_type.peppyalsa {
    lib /data/plugins/user_interface/peppy_screensaver/lib/libpeppyalsa.so
}

# null output
pcm.dummy {
  type hw
	card Dummy
	device 0
}

# needed for some sound cards otherwiese Spotify stops playing after 10 seconds
pcm.copy_output {
  type ${type}
  slave.pcm "postpeppyalsa"
}

pcm.postpeppyalsa {
  type empty
  slave.pcm "postPeppyalsa"
}
#------ End of PeppyMeter section ------
